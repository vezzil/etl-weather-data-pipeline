"""
Pytest configuration for the weather ETL pipeline test suite
"""

import pytest
import sys
import os

# Add the src directory to the Python path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))

def pytest_configure(config):
    """Configure pytest with custom markers"""
    config.addinivalue_line(
        "markers", "integration: marks tests as integration tests (deselect with '-m \"not integration\"')"
    )
    config.addinivalue_line(
        "markers", "slow: marks tests as slow tests (deselect with '-m \"not slow\"')"
    )
    config.addinivalue_line(
        "markers", "unit: marks tests as unit tests"
    )

def pytest_collection_modifyitems(config, items):
    """Automatically mark tests based on their location and name"""
    for item in items:
        # Mark integration tests
        if "integration" in item.nodeid.lower() or "test_integration" in item.nodeid:
            item.add_marker(pytest.mark.integration)
        
        # Mark slow tests
        if "stress" in item.nodeid.lower() or "large_dataset" in item.nodeid.lower():
            item.add_marker(pytest.mark.slow)
        
        # Mark unit tests (default for most tests)
        if not any(marker.name in ['integration', 'slow'] for marker in item.iter_markers()):
            item.add_marker(pytest.mark.unit)

@pytest.fixture(scope="session", autouse=True)
def setup_test_environment():
    """Set up test environment variables and configuration"""
    # Set test environment variables
    os.environ['TESTING'] = 'true'
    os.environ['LOG_LEVEL'] = 'WARNING'  # Reduce log noise during tests
    
    # Mock API key for tests
    if 'OPENWEATHER_API_KEY' not in os.environ:
        os.environ['OPENWEATHER_API_KEY'] = 'test_api_key'
    
    yield
    
    # Cleanup after all tests
    if 'TESTING' in os.environ:
        del os.environ['TESTING']